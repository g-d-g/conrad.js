/* conrad.js - A tiny JavaScript jobs scheduler - Version: 0.1.0 - Author:  Alexis Jacomy, Sciences-Po mÃ©dialab - License: MIT */
!function(a){"use strict";function b(a,c){var d,e,f;if(!arguments.length)return this;if(1===arguments.length&&"object"==typeof arguments[0])for(a in arguments[0])b(a,arguments[0][a]);else if(arguments.length>1){f="[object Array]"===Object.prototype.toString.call(a)?a:a.split(/ /);for(d in f)e=f[d],C[e]||(C[e]=[]),C[e].push({handler:c})}return this}function c(a,b){var c,d,e,f,g="[object Array]"===Object.prototype.toString.call(a)?a:a.split(/ /);if(!arguments.length){for(c in C)delete C[c];return this}if(b)for(c in g){if(f=g[c],C[f]){e=[];for(d in C[f])C[f][d].handler!==b&&e.push(C[f][d]);C[f]=e}C[f]&&0===C[f].length&&delete C[f]}else for(c in g)delete C[g[c]];return this}function d(b,c){var d,e,f,g,h="[object Array]"===Object.prototype.toString.call(b)?b:b.split(/ /);c=c===a?{}:c;for(d in h)if(g=h[d],C[g]){f={type:g,data:c||{}};for(e in C[g])C[g][e].handler(f)}return this}function e(a){var b,c,d,e,f=!1,g=s(),a=x.shift();if(d=a.job(),g=s()-g,a.done++,a.time+=g,a.currentTime+=g,a.weightTime=a.currentTime/(a.weight||1),a.averageTime=a.time/a.done,e=a.count?a.count<=a.done:!d,!e){for(b=0,c=x.length;c>b;b++)if(x[b].weightTime>a.weightTime){x.splice(b,0,a),f=!0;break}f||x.push(a)}return e?a:null}function f(a){var b=x.length;w[a.id]=a,a.status="running",b&&(a.weightTime=x[b-1].weightTime,a.currentTime=a.weightTime*(a.weight||1)),a.startTime=s(),d("jobStarted",q(a)),x.push(a)}function g(){var a,b,c;for(a in v)b=v[a],b.after?y[a]=b:f(b),delete v[a];for(u=!!x.length;x.length&&s()-t<B.frameDuration;)if(c=e()){i(c.id);for(a in y)y[a].after===c.id&&(f(y[a]),delete y[a])}u?(t=s(),d("enterFrame"),setTimeout(g,0)):d("stop")}function h(a,b){var c,e,f;if("[object Array]"===Object.prototype.toString.call(a)){for(A=!0,c=0,e=a.length;e>c;c++)h(a[c].id,p(a[c],b));A=!1,u||(t=s(),d("start"),g())}else if("object"==typeof a)if("string"==typeof a.id)h(a.id,a);else{A=!0;for(c in a)"function"==typeof a[c]?h(c,p({job:a[c]},b)):h(c,p(a[c],b));A=!1,u||(t=s(),d("start"),g())}else{if("string"!=typeof a)throw new Error("[conrad.addJob] Wrong arguments.");if(k(a))throw new Error('[conrad.addJob] Job with id "'+a+'" already exists.');if("function"==typeof b)f={id:a,done:0,time:0,status:"waiting",currentTime:0,averageTime:0,weightTime:0,job:b};else{if("object"!=typeof b)throw new Error("[conrad.addJob] Wrong arguments.");f=p({id:a,done:0,time:0,status:"waiting",currentTime:0,averageTime:0,weightTime:0},b)}v[a]=f,d("jobAdded",q(f)),u||A||(t=s(),d("start"),g())}return this}function i(a){var b,c,e,f,g=!1;if("[object Array]"===Object.prototype.toString.call(a))for(b=0,c=a.length;c>b;b++)i(a[b]);else{if("string"!=typeof a)throw new Error("[conrad.killJob] Wrong arguments.");for(e=[w,y,v],b=0,c=e.length;c>b;b++)a in e[b]&&(f=e[b][a],B.history&&(f.status="done",z.push(f)),d("jobEnded",q(f)),delete e[b][a],"function"==typeof f.end&&f.end(),g=!0);for(e=x,b=0,c=e.length;c>b;b++)if(e[b].id===a){e.splice(b,1);break}if(!g)throw new Error('[conrad.killJob] Job "'+a+'" not found.')}return this}function j(){var a,b=p(v,w,y);if(B.history)for(a in b)b[a].status="done",z.push(b[a]),"function"==typeof b[a].end&&b[a].end();return v={},y={},w={},x=[],u=!1,this}function k(a){var b=v[a]||w[a]||y[a];return b?p(b):null}function l(){var b;if("string"==typeof a1&&1===arguments.length)return B[a1];b="object"==typeof a1&&1===arguments.length?a1||{}:{},"string"==typeof a1&&(b[a1]=a2);for(var c in b)b[c]!==a?B[c]=b[c]:delete B[c];return this}function m(){return!!u}function n(){return z=[],this}function o(a,b){var c,d,e,f,g,h,i;if(!arguments.length){g=[];for(d in v)g.push(v[d]);for(d in y)g.push(y[d]);for(d in w)g.push(w[d]);g=g.concat(z)}if("string"==typeof a)switch(a){case"waiting":g=r(y);break;case"running":g=r(w);break;case"done":g=z;break;default:h=a}if(a instanceof RegExp&&(h=a),!h&&("string"==typeof b||b instanceof RegExp)&&(h=b),h){if(i="string"==typeof h,g instanceof Array)c=g;else if("object"==typeof g){c=[];for(d in g)c=c.concat(g[d])}else{c=[];for(d in v)c.push(v[d]);for(d in y)c.push(y[d]);for(d in w)c.push(w[d]);c=c.concat(z)}for(g=[],e=0,f=c.length;f>e;e++)(i?c[e].id===h:c[e].id.match(h))&&g.push(c[e])}return q(g)}function p(){var a,b,c={},d=arguments.length;for(a=d-1;a>=0;a--)for(b in arguments[a])c[b]=arguments[a][b];return c}function q(a){var b,c,d;if(!a)return a;if("[object Array]"===Object.prototype.toString.call(a))for(b=[],c=0,d=a.length;d>c;c++)b.push(q(a[c]));else if("object"==typeof a){b={};for(c in a)b[c]=q(a[c])}else b=a;return b}function r(a){var b,c=[];for(b in a)c.push(a[b]);return c}function s(){return Date.now?Date.now():(new Date).getTime()}if(this.conrad)throw new Error("conrad already exists");var t,u=!1,v={},w={},x=[],y={},z=[],A=!1,B={frameDuration:20,history:!0},C={};this.conrad={hasJob:k,addJob:h,killJob:i,killAll:j,settings:l,getStats:o,isRunning:m,clearHistory:n,bind:b,unbind:c,version:"0.1.0"}}.call(this);