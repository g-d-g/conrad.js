/* conrad.js - A tiny JavaScript jobs scheduler - Version: 0.1.0 - Author:  Alexis Jacomy, Sciences-Po mÃ©dialab - License: MIT */
!function(a){"use strict";function b(a,c){var d,e,a,f,c;if(!arguments.length)return this;if(1===arguments.length&&"object"==typeof arguments[0])for(a in arguments[0])b(a,arguments[0][a]);else if(arguments.length>1){a=arguments[0],c=arguments[1],f="[object Array]"===Object.prototype.toString.call(a)?a:a.split(/ /);for(d in f)e=f[d],B[e]||(B[e]=[]),B[e].push({handler:c})}return this}function c(a,b){var c,d,e,f,g="[object Array]"===Object.prototype.toString.call(a)?a:a.split(/ /);if(!arguments.length){for(c in B)delete B[c];return this}if(b)for(c in g){if(f=g[c],B[f]){e=[];for(d in B[f])B[f][d].handler!==b&&e.push(B[f][d]);B[f]=e}B[f]&&0===B[f].length&&delete B[f]}else for(c in g)delete B[g[c]];return this}function d(b,c){var d,e,f,g,h,i="[object Array]"===Object.prototype.toString.call(b)?b:b.split(/ /);c=c===a?{}:c;for(d in i)if(h=i[d],B[h]){f=[],g={type:h,data:c||{}};for(e in B[h])B[h][e].handler(g);B[h]=f}return this}function e(a){var b,c,d,e,f=!1,g=r(),a=w.shift();if(d=a.job(),g=r()-g,a.done++,a.time+=g,a.currentTime+=g,a.weightTime=a.currentTime/(a.weight||1),a.averageTime=a.time/a.done,e=a.count?a.count<=a.done:!d,!e){for(b=0,c=w.length;c>b;b++)if(w[b].weightTime>a.weightTime){w.splice(b,0,a),f=!0;break}f||w.push(a)}return e?a:null}function f(a){var b=w.length;v[a.id]=a,a.status="running",b&&(a.weightTime=w[b-1].weightTime,a.currentTime=a.weightTime*(a.weight||1)),a.startTime=r(),d("jobStarted",p(a)),w.push(a)}function g(){var a,b,c;t=!1;for(a in u)b=u[a],b.after?x[a]=b:f(b),delete u[a];for(;w.length&&r()-s<A.frameDuration;)if(t=!0,c=e()){i(c.id);for(a in x)x[a].after===c.id&&(f(x[a]),delete x[a])}t?(s=r(),d("enterFrame"),setTimeout(g,0)):d("stop")}function h(a,b){var c,e,f;if("[object Array]"===Object.prototype.toString.call(a)){for(z=!0,c=0,e=a.length;e>c;c++)h(a[c].id,o(a[c],b));z=!1,t||g()}else if("object"==typeof a)if("string"==typeof a.id)h(a.id,a);else{z=!0;for(c in a)"function"==typeof a[c]?h(c,o({job:a[c]},b)):h(c,o(a[c],b));z=!1,t||g()}else{if("string"!=typeof a)throw new Error("[conrad.addJob] Wrong arguments.");if(k(a))throw new Error('[conrad.addJob] Job with id "'+a+'" already exists.');if("function"==typeof b)f={id:a,done:0,time:0,status:"waiting",currentTime:0,averageTime:0,weightTime:0,job:b};else{if("object"!=typeof b)throw new Error("[conrad.addJob] Wrong arguments.");f=o({id:a,done:0,time:0,status:"waiting",currentTime:0,averageTime:0,weightTime:0},b)}u[a]=f,d("jobAdded",p(f)),t||z||(s=r(),d("start"),g())}return this}function i(a){var b,c,e,f,g=!1;if("[object Array]"===Object.prototype.toString.call(a))for(b=0,c=a.length;c>b;b++)i(a[b]);else{if("string"!=typeof a)throw new Error("[conrad.killJob] Wrong arguments.");for(e=[v,x,u],b=0,c=e.length;c>b;b++)a in e[b]&&(f=e[b][a],A.history&&(f.status="done",y.push(f)),"function"==typeof f.end&&f.end(),d("jobEnded",p(f)),delete e[b][a],g=!0);for(e=w,b=0,c=e.length;c>b;b++)if(e[b].id===a){e.splice(b,1);break}if(!g)throw new Error('[conrad.killJob] Job "'+a+'" not found.')}return this}function j(){var a,b=o(u,v,x);if(A.history)for(a in b)b[a].status="done",y.push(b[a]);return u={},x={},v={},w=[],t=!1,this}function k(a){var b=u[a]||v[a]||x[a];return b?o(b):null}function l(){var b;if("string"==typeof a1&&1===arguments.length)return A[a1];b="object"==typeof a1&&1===arguments.length?a1||{}:{},"string"==typeof a1&&(b[a1]=a2);for(var c in b)b[c]!==a?A[c]=b[c]:delete A[c];return this}function m(){return y=[],this}function n(a,b){var c,d,e,f,g,h,i;if(!arguments.length){g=[];for(d in u)g.push(u[d]);for(d in x)g.push(x[d]);for(d in v)g.push(v[d]);g=g.concat(y)}if("string"==typeof a)switch(a){case"waiting":g=q(x);break;case"running":g=q(v);break;case"done":g=y;break;default:h=a}if(a instanceof RegExp&&(h=a),!h&&("string"==typeof b||b instanceof RegExp)&&(h=b),h){if(i="string"==typeof h,g instanceof Array)c=g;else if("object"==typeof g){c=[];for(d in g)c=c.concat(g[d])}else{c=[];for(d in u)c.push(u[d]);for(d in x)c.push(x[d]);for(d in v)c.push(v[d]);c=c.concat(y)}for(g=[],e=0,f=c.length;f>e;e++)(i?c[e].id===h:c[e].id.match(h))&&g.push(c[e])}return p(g)}function o(){var a,b,c={},d=arguments.length;for(a=d-1;a>=0;a--)for(b in arguments[a])c[b]=arguments[a][b];return c}function p(a){var b,c,d;if(!a)return a;if("[object Array]"===Object.prototype.toString.call(a))for(b=[],c=0,d=a.length;d>c;c++)b.push(p(a[c]));else if("object"==typeof a){b={};for(c in a)b[c]=p(a[c])}else b=a;return b}function q(a){var b,c=[];for(b in a)c.push(a[b]);return c}function r(){return Date.now?Date.now():(new Date).getTime()}if(this.conrad)throw new Error("conrad already exists");var s,t=!1,u={},v={},w=[],x={},y=[],z=!1,A={frameDuration:20,history:!0},B={};this.conrad={hasJob:k,addJob:h,killJob:i,killAll:j,settings:l,getStats:n,clearHistory:m,bind:b,unbind:c,version:"0.1.0"}}.call(this);